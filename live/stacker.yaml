base:
  build_only: true
  from:
    type: docker
    url: "docker://zothub.io/machine/bootkit/rootfs:0.0.5.230327-squashfs"

rootfs-pkg:
  build_only: true
  from:
    type: built
    tag: base
  run: |
    pkgtool install udev kmod \
        tpm2-tools e2fsprogs \
        openssh-client

rootfs:
  from:
    type: built
    tag: rootfs-pkg
  import:
    - ../trust
    - trust-provision
    - trust-provision.service
    - trust-provision-failed.service
    - console-helper
  run: |
    #!/bin/sh -ex
    writefile() {
      mkdir -p "${1%/*}"
      echo "write $1" 1>&2
      cat >"$1"
    }

    writefile /etc/systemd/network/20-wire-enp0s-dhcp.network <<"END"
    [Match]
    Name=enp0s*
    [Network]
    DHCP=yes
    END

    cd /stacker
    cp trust trust-provision console-helper /usr/bin
    ( cd /usr/bin && chmod 755 trust trust-provision console-helper )

    cp trust-provision.service trust-provision-failed.service \
        /etc/systemd/system/

    cd /
    mkdir -p /etc/systemd/system/multi-user.target.wants

    cd /etc/systemd/system/
    for s in trust-provision*.service; do
      ln -s "$PWD/$s" "/etc/systemd/system/multi-user.target.wants/$s"
    done
    ls -ltr /etc/systemd/system/*.service

    systemctl enable debug-shell.service
    systemctl mask serial-getty@ttyS0

    ## FIXME
    echo root:passw0rd | chpasswd
